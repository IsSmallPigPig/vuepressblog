---
author: YOUZAI
title: Nginx 文件名逻辑漏洞（CVE-2013-4547）
date: 2023/06/20
categories:
 - 漏洞文库
tags:
 - Nginx
---

## 漏洞简介

非法字符空格和截止符（\0）会导致 Nginx 解析 URL 时的有限状态机混乱，此漏洞可导致目录跨越及代码执行。

::: info 影响版本

- [x] Nginx 0.8.41 ~ 1.4.3 / 1.5.0 ~ 1.5.7

:::

## 漏洞复现

使用 docker 搭建环境：

![](/images/微信图片_20220905112333.png)

上传文件，并在文件名的后面加上一个空格：

![](/images/微信图片_20220905112513.png)

::: tip 提示

如果是 Windows 系统，文件名后面不需要空格，因为系统读取文件时会自动将空格删去。

:::

由于浏览器会自动进行 URL 编码，所以我们需要抓包访问。

访问路径：http://localhost/uploadfiles/shell.jpg[0x20][0x00].php

![](/images/微信图片_20220905112805.png)

可以看到 jpg 文件被解析成 php 文件。

::: tip 关于 \0

在 ascii 码中没有 \0 这个选项，但是在 ascii 编码中，有一个 `0x00` 表示 null，这个 null 就相当于是 \0 的功能。

:::

|Bin(二进制)|Oct(八进制)|Dec(十进制)|Hex(十六进制)|缩写/字符|解释|
|:-:|:-:|:-:|:-:|:-:|:-:|
|0000 0000|00|0|0x00|NUL(null)|空字符|

## 漏洞原理

Nginx 会将读取到的 php 文件交给 fastcgi 解析，在 Nginx 的配置文件中可以看到如下配置：

::: tip 提示

Nginx 在 Linux 下的默认路径是：/usr/local/nginx/conf/nginx.conf

:::

![](/images/微信图片_20220905114900.png)

大部分情况下，网站是不允许直接上传 php 文件的，所以一般都是通过上传图片格式的文件，在图片中添加恶意代码，利用服务器的错误配置或者解析漏洞 getshell。这里是利用了一些让服务器做出一些错误的判断的操作，误认为这个文件就是 php 的文件，自然而然服务器就会把文件当作 php 的文件去执行。

::: tip 知识点

在正则表达式中如果遇到了 \0 是不会停止匹配的，但是 Nginx 会停止。这个 \0 叫做截断符，可以理解为结束符，就是如果我们使用非法的字符空格和截断符会使 Nginx 解析 URL 的时候状态混乱，这样我们就可以通过一个非编码空格绕过后缀名的限制。

:::

我们可以通过一个简单的例子说明：在服务器中有一个文件“shell.txt ”，文件名的最后面有一个空格，正确读取该文件的路径应该是 /\*/shell.txt，这是如果我们用路径 /\*/shell.txt \0.php 读取的话，相当于在路径的后面添加了一个空格和一个截断符号，这回导致状态机制混乱，服务器会认为 shell.txt 是文件名，而后面的 php 是文件格式，由于他们是非法空格和截断符，所以他们不参与文件名和文件格式解析，从而造成原本应该是按照 txt 格式读取文件的方式变成了按照 php 读取文件的方式，也就造成了解析漏洞。

## 漏洞修复

* php-fpm.conf 中的 security.limit_extensions 后面的值设置为 .php。