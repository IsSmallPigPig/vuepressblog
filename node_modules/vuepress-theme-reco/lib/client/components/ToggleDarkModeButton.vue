<template>
  <div ref="togglemode" @click="toggleMode()">
    <div class="btn-toggle-dark-mode">
      <div v-if="icon === 'auto'">
        <svg xml:space="preserve" viewBox="0 0 100 100" y="0" x="0" xmlns="http://www.w3.org/2000/svg" id="" version="1.1" style="height: 100%; width: 100%; background: rgb(255, 255, 255, 0);" width="20px" height="20px"><g class="ldl-scale" style="transform-origin: 50% 50%; transform: rotate(0deg) scale(1, 1);"><g class="ldl-ani"><g class="ldl-layer"><g class="ldl-ani" style="transform-origin: 50px 50px; animation: 1.11111s linear -0.833333s infinite normal forwards running static-fdeef450-e1af-4b38-82c5-87146883ab50;"><circle fill="#ffdc6c" r="34.5" cy="50" cx="50.5" style="fill: rgb(255, 220, 108);"></circle></g></g><g class="ldl-layer"><g class="ldl-ani" style="transform-origin: 50px 50px; animation: 1.11111s linear -1.11111s infinite normal forwards running static-fdeef450-e1af-4b38-82c5-87146883ab50;"><path stroke-miterlimit="10" stroke-width="3" stroke="#fff" fill="#e0e0e0" d="M38.3 74.8h-1.4c-2 0-3.7-1.5-3.7-3.5 0 0 0 0 0 0s0 0 0 0c0-2 1.7-3.5 3.7-3.5h34.8c3.2 0 6-2.5 6.1-5.7.1-3.3-2.6-6.1-5.9-6.1h-53-.1c-1.4 0-2.8.5-3.8 1.4-1.3 1-2.2 2.6-2.2 4.4-.1 3.3 2.6 6.1 5.9 6.1H21.8c1.1 0 2.1.5 2.8 1.3.1.1.2.3.3.4.3.5.5 1.1.5 1.8 0 0 0 0 0 0s0 0 0 0c0 1.4-.5 2.6-1.5 3.2-.4.2-.8.3-1.3.3h-1.2c-3.2 0-6 2.5-6.1 5.7-.1 3.3 2.6 6.1 5.9 6.1h17c1.4 0 2.7-.5 3.8-1.3 1.1-.9 2-2.1 2.2-3.6.1-.3.1-.6.1-.8 0-3.5-2.7-6.2-6-6.2z" style="stroke: rgb(255, 255, 255); fill: rgb(224, 224, 224);"></path></g></g><metadata xmlns:d="https://loading.io/stock/"></metadata></g></g></svg>
      </div>
      <div v-if="icon === 'sun'">
        <svg xml:space="preserve" viewBox="0 0 100 100" y="0" x="0" xmlns="http://www.w3.org/2000/svg" id="" version="1.1" style="height: 100%; width: 100%; background: rgb(255, 255, 255, 0);" width="20px" height="20px"><g class="ldl-scale" style="transform-origin: 50% 50%; transform: rotate(0deg);"><g class="ldl-ani"><g class="ldl-layer"><g class="ldl-ani" style="transform-origin: 50px 50px; animation: 1.11111s linear -0.598291s infinite normal forwards running static-4e2e44f7-7864-4ba7-bd6b-c750d02debb7;"><circle fill="#ffdc6c" r="27" cy="50" cx="50" style="fill: rgb(255, 220, 108);"></circle></g></g><g class="ldl-layer"><g class="ldl-ani" style="transform-origin: 50px 50px; animation: 1.11111s linear -0.641026s infinite normal forwards running static-4e2e44f7-7864-4ba7-bd6b-c750d02debb7;"><path fill="#f8b26a" d="M50 19.3c1.2 0 2.3.1 3.5.2L50 7.5l-3.5 12c1.2-.1 2.3-.2 3.5-.2z" style="fill: rgb(248, 178, 106);"></path></g></g><g class="ldl-layer"><g class="ldl-ani" style="transform-origin: 50px 50px; animation: 1.11111s linear -0.683761s infinite normal forwards running static-4e2e44f7-7864-4ba7-bd6b-c750d02debb7;"><path fill="#f8b26a" d="M37.7 21.9l-9-8.7 3 12.1c1.9-1.4 3.9-2.5 6-3.4z" style="fill: rgb(248, 178, 106);"></path></g></g><g class="ldl-layer"><g class="ldl-ani" style="transform-origin: 50px 50px; animation: 1.11111s linear -0.726496s infinite normal forwards running static-4e2e44f7-7864-4ba7-bd6b-c750d02debb7;"><path fill="#f8b26a" d="M25.3 31.8l-12.1-3 8.7 9c.9-2.2 2-4.2 3.4-6z" style="fill: rgb(248, 178, 106);"></path></g></g><g class="ldl-layer"><g class="ldl-ani" style="transform-origin: 50px 50px; animation: 1.11111s linear -0.769231s infinite normal forwards running static-4e2e44f7-7864-4ba7-bd6b-c750d02debb7;"><path fill="#f8b26a" d="M92.5 50l-12-3.5c.1 1.1.2 2.3.2 3.5s-.1 2.3-.2 3.5l12-3.5z" style="fill: rgb(248, 178, 106);"></path></g></g><g class="ldl-layer"><g class="ldl-ani" style="transform-origin: 50px 50px; animation: 1.11111s linear -0.811966s infinite normal forwards running static-4e2e44f7-7864-4ba7-bd6b-c750d02debb7;"><path fill="#f8b26a" d="M78.1 37.7l8.7-9-12.1 3c1.4 1.9 2.5 3.9 3.4 6z" style="fill: rgb(248, 178, 106);"></path></g></g><g class="ldl-layer"><g class="ldl-ani" style="transform-origin: 50px 50px; animation: 1.11111s linear -0.854701s infinite normal forwards running static-4e2e44f7-7864-4ba7-bd6b-c750d02debb7;"><path fill="#f8b26a" d="M68.2 25.3l3-12.1-9 8.7c2.2.9 4.2 2 6 3.4z" style="fill: rgb(248, 178, 106);"></path></g></g><g class="ldl-layer"><g class="ldl-ani" style="transform-origin: 50px 50px; animation: 1.11111s linear -0.897436s infinite normal forwards running static-4e2e44f7-7864-4ba7-bd6b-c750d02debb7;"><path fill="#f8b26a" d="M62.3 78.1l9 8.7-3-12.1c-1.9 1.4-3.9 2.5-6 3.4z" style="fill: rgb(248, 178, 106);"></path></g></g><g class="ldl-layer"><g class="ldl-ani" style="transform-origin: 50px 50px; animation: 1.11111s linear -0.940171s infinite normal forwards running static-4e2e44f7-7864-4ba7-bd6b-c750d02debb7;"><path fill="#f8b26a" d="M74.7 68.2l12.1 3-8.7-9c-.9 2.2-2 4.2-3.4 6z" style="fill: rgb(248, 178, 106);"></path></g></g><g class="ldl-layer"><g class="ldl-ani" style="transform-origin: 50px 50px; animation: 1.11111s linear -0.982906s infinite normal forwards running static-4e2e44f7-7864-4ba7-bd6b-c750d02debb7;"><path fill="#f8b26a" d="M50 80.7c-1.2 0-2.3-.1-3.5-.2l3.5 12 3.5-12c-1.2.1-2.3.2-3.5.2z" style="fill: rgb(248, 178, 106);"></path></g></g><g class="ldl-layer"><g class="ldl-ani" style="transform-origin: 50px 50px; animation: 1.11111s linear -1.02564s infinite normal forwards running static-4e2e44f7-7864-4ba7-bd6b-c750d02debb7;"><path fill="#f8b26a" d="M21.9 62.3l-8.7 9 12.1-3c-1.4-1.9-2.5-3.9-3.4-6z" style="fill: rgb(248, 178, 106);"></path></g></g><g class="ldl-layer"><g class="ldl-ani" style="transform-origin: 50px 50px; animation: 1.11111s linear -1.06838s infinite normal forwards running static-4e2e44f7-7864-4ba7-bd6b-c750d02debb7;"><path fill="#f8b26a" d="M31.8 74.7l-3 12.1 9-8.7c-2.2-.9-4.2-2-6-3.4z" style="fill: rgb(248, 178, 106);"></path></g></g><g class="ldl-layer"><g class="ldl-ani" style="transform-origin: 50px 50px; animation: 1.11111s linear -1.11111s infinite normal forwards running static-4e2e44f7-7864-4ba7-bd6b-c750d02debb7;"><path fill="#f8b26a" d="M19.3 50c0-1.2.1-2.3.2-3.5L7.5 50l12 3.5c-.1-1.2-.2-2.3-.2-3.5z" style="fill: rgb(248, 178, 106);"></path></g></g><metadata xmlns:d="https://loading.io/stock/"></metadata></g></g></svg>
      </div>
      <div v-if="icon === 'moon'">
        <svg xml:space="preserve" viewBox="0 0 100 100" y="0" x="0" xmlns="http://www.w3.org/2000/svg" id="" version="1.1" style="height: 100%; width: 100%; background: rgb(255, 255, 255, 0);" width="200px" height="200px"><g class="ldl-scale" style="transform-origin: 50% 50%; transform: rotate(0deg) scale(1, 1);"><g class="ldl-ani"><g class="ldl-layer"><g class="ldl-ani" style="transform-origin: 50px 50px; animation: 1.11111s linear -0.740741s infinite normal forwards running static-461db086-58c0-4a48-bfce-72e8d85f4606;"><path fill="#f8b26a" clip-rule="evenodd" fill-rule="evenodd" d="M65.2 69.6c-21.7 0-39.3-17.2-39.3-38.3 0-8 2.5-15.4 6.8-21.6.6-.9-.3-2-1.3-1.6-13.2 6.4-22.7 19.4-24 34.8-2.3 26.2 20.1 48.6 46.3 46.2C69.2 87.7 82.4 78 88.6 64.5c.4-1-.6-1.9-1.5-1.3-6.3 4-13.8 6.4-21.9 6.4z" style="fill: rgb(248, 178, 106);"></path></g></g><g class="ldl-layer"><g class="ldl-ani" style="transform-origin: 50px 50px; animation: 1.11111s linear -0.925926s infinite normal forwards running static-461db086-58c0-4a48-bfce-72e8d85f4606;"><path fill="#f5e6c8" clip-rule="evenodd" fill-rule="evenodd" d="M79.3 25.2l2.6 5.2c.1.2.3.3.5.4l5.8.8c.5.1.8.7.4 1.1l-4.2 4.1c-.2.2-.2.4-.2.6l1 5.8c.1.5-.5 1-1 .7L79 41.2c-.2-.1-.4-.1-.6 0l-5.2 2.7c-.5.3-1.1-.2-1-.7l1-5.8c0-.2 0-.4-.2-.6l-4.2-4.1c-.4-.4-.2-1 .4-1.1l5.8-.8c.2 0 .4-.2.5-.4l2.6-5.2c.2-.5.9-.5 1.2 0z" style="fill: rgb(245, 230, 200);"></path></g></g><g class="ldl-layer"><g class="ldl-ani" style="transform-origin: 50px 50px; animation: 1.11111s linear -1.11111s infinite normal forwards running static-461db086-58c0-4a48-bfce-72e8d85f4606;"><path fill="#f5e6c8" clip-rule="evenodd" fill-rule="evenodd" d="M50.5 12.8l2.1 4.3c.1.2.2.3.4.3l4.7.7c.4.1.6.6.3.9l-3.4 3.3c-.1.1-.2.3-.2.5l.8 4.7c.1.4-.4.8-.8.6l-4.2-2.2c-.2-.1-.3-.1-.5 0l-4.2 2.2c-.4.2-.9-.1-.8-.6l.8-4.7c0-.2 0-.4-.2-.5L42 19c-.3-.3-.1-.9.3-.9l4.7-.7c.2 0 .3-.1.4-.3l2.1-4.3c.2-.4.8-.4 1 0z" style="fill: rgb(245, 230, 200);"></path></g></g><metadata xmlns:d="https://loading.io/stock/"></metadata></g></g></svg>
      </div>
    </div>
  </div>
</template>

<script setup lang="ts">
import { ref, computed, onMounted, watch, Ref } from 'vue'
import { useThemeLocaleData } from '../composables/'

enum ModeIcon {
  auto = 'auto',
  dark = 'moon',
  light = 'sun'
}

enum EMode {
  auto,
  dark,
  light
}

type TMode = keyof typeof EMode

const themeConfig = useThemeLocaleData()

const APPEARANCE_KEY = 'vuepress-reco-color-scheme'

const mode: Ref<TMode> = ref(themeConfig.value.colorMode || 'auto')

const togglemode = ref()

defineExpose({ togglemode })

const icon = computed(() => {
  return ModeIcon[mode.value]
})

let toggleMode = () => {
  const currModeIndex = EMode[mode.value]
  const nextModeIndex = currModeIndex === 2 ? 0 : currModeIndex + 1

  mode.value = EMode[nextModeIndex] as TMode
}

onMounted(() => {
  const userPreference = localStorage[APPEARANCE_KEY]

  if (userPreference) {
    mode.value = userPreference
  }

  const classList = document.documentElement.classList

  function setDarkClass(dark: boolean): void {
    classList.toggle('dark', dark)
  }

  function handleModeChange(m) {
    if (m === 'auto') {
      setDarkClass(darkMedia.matches)
      localStorage.removeItem(APPEARANCE_KEY)
    } else {
      setDarkClass(m === 'dark')
      localStorage.setItem(APPEARANCE_KEY, m)
      // localStorage[APPEARANCE_KEY] = m
    }
  }

  const darkMedia = window.matchMedia('(prefers-color-scheme: dark)')

  // 监听系统化的 mode 变化
  darkMedia.onchange = (e) => {
    if (mode.value === 'auto') {
      setDarkClass((e.matches))
    }
  }

  // 监听手动切换 mode
  watch(mode, handleModeChange)

  handleModeChange(mode.value)
})
</script>
