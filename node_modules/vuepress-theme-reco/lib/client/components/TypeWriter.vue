<template>
    <p class="typewriter-container">
      <div class="word">
        <div class="left">『</div>
        <span class="typed-text">{{ typeValue }}</span>
        <div class="right">』</div>
        <!-- <span class="cursor" :class="{ typing: typeStatus }">&nbsp;</span> -->
      </div>
      <div class="author" ref="authorRef"> ——「悠哉的日常」</div>
    </p>
</template>
  
<script setup lang="ts">
import { ref, onMounted, onUnmounted } from 'vue';

const typeValue = ref('')
const authorRef = ref()
const typeTextTimer = ref()

let displayTextArray: string[]
let typeStatus: boolean = false
let authorDisplay: boolean = false
let typingSpeed: number = 0
let erasingSpeed: number = 0
let newTextDelay: number = 0
let charIndex: number = 0
let displayTextArrayIndex: number = 0
let displayTextArrayLength: number = 0

const typeText = () => {
    if (charIndex < displayTextArray[displayTextArrayIndex].length) {
        displayTextArrayLength = displayTextArray[displayTextArrayIndex].length
        if (!typeStatus) typeStatus = true
        typeValue.value += displayTextArray[displayTextArrayIndex].charAt(charIndex)
        charIndex += 1
        typeTextTimer.value = setTimeout(typeText, typingSpeed)
        if (!authorDisplay) {
            if(displayTextArrayLength >= 6 && charIndex >= 5) {
                authorDisplay = !authorDisplay
                authorChange(authorDisplay)
            } else if(displayTextArrayLength < 5){
                authorDisplay = !authorDisplay
                authorChange(authorDisplay)
            }
        }
    } else {
        typeStatus = false
        typeTextTimer.value = setTimeout(eraseText, newTextDelay)
    }
}

const eraseText = () => {
    if (charIndex > 0) {
        if (!typeStatus) typeStatus = true
        typeValue.value = displayTextArray[displayTextArrayIndex].substring(0, charIndex - 1)
        charIndex -= 1
        typeTextTimer.value = setTimeout(eraseText, erasingSpeed)
        if (authorDisplay) {
            if(displayTextArrayLength >= 11 && charIndex <= 10) {
                authorDisplay = !authorDisplay
                authorChange(authorDisplay)
            } else if(displayTextArrayLength < 9){
                authorDisplay = !authorDisplay
                authorChange(authorDisplay)
            }
        }
    } else {
        typeStatus = false
        displayTextArrayIndex += 1
        if (displayTextArrayIndex >= displayTextArray.length) displayTextArrayIndex = 0
        typeTextTimer.value = setTimeout(typeText, newTextDelay)
    }
}

const authorChange = (change: boolean) => {
    if(!!change) {
        authorRef.value.style.opacity = "1"
    } else {
        authorRef.value.style.opacity = "0"
    }
}

onMounted(() => {
    displayTextArray = ["愿每个人都有属于自己的一片星空。"]
    typingSpeed =  150
    erasingSpeed = 150
    newTextDelay = 2000
    typeTextTimer.value = setTimeout(typeText, newTextDelay)
})

onUnmounted(() => {
    clearTimeout(typeTextTimer.value)
})
</script>

<!-- Add "scoped" attribute to limit CSS to this component only -->
<style lang="scss">
.typewriter-container {
    font-size: 1.8rem;
    position: relative;
    margin: 0 auto;

    .word {
        position: relative;
        padding: 1rem 2.5rem;
        text-align: center;

        .left {
            position: absolute;
            left: 0;
            top: 0;
        }

        .right {
            position: absolute;
            right: 0;
            bottom: 0;
        }

        .typed-text {
            color: #000;
            max-width: 80vw;
            position: relative;
            display: inline-block;
            font-size: 1.8rem;
            // text-shadow: 0 0 5px #fff,
            //     0 0 10px #fff,
            //     0 0 10px #fff,
            //     0 0 10px #00a67d2f,
            //     0 0 10px #00a67d2f,
            //     0 0 10px #00a67d2f,
            //     0 0 10px #00a67d2f,
            //     0 0 10px #00a67d2f;

            &::after {
                color: #000;
                content: "|";
                font-size: 1.8rem;
                animation: blink .8s infinite;
            }
        }
    }

    .author {
        font-size: 1rem;
        float: right;
        transition: opacity 1s cubic-bezier(0.4, 0, 0.2, 1);
        opacity: 0;
    }
}

.dark .typewriter-container {
    .word {
        .typed-text {
            color: azure;
            &::after {
                color: azure;
                animation: blink_d .8s infinite;
            }
        }
    }
}

// Cursor blinking CSS Starts...
// .blinking-cursor {
//     font-size: 1.8rem;
//     color: #2c3e50;
//     -webkit-animation: 1s blink step-end infinite;
//     -moz-animation: 1s blink step-end infinite;
//     -ms-animation: 1s blink step-end infinite;
//     -o-animation: 1s blink step-end infinite;
//     animation: 1s blink step-end infinite;
// }

@keyframes blink {
    from,
    to {
        color: transparent;
    }
    50% {
        color: #2c3e50;
    }
}
@-moz-keyframes blink {
    from,
    to {
        color: transparent;
    }
    50% {
        color: #2c3e50;
    }
}
@-webkit-keyframes blink {
    from,
    to {
        color: transparent;
    }
    50% {
        color: #2c3e50;
    }
}
@-ms-keyframes blink {
    from,
    to {
        color: transparent;
    }
    50% {
        color: #2c3e50;
    }
}
@-o-keyframes blink {
    from,
    to {
        color: transparent;
    }
    50% {
        color: #2c3e50;
    }
}

@keyframes blink_d {
    from,
    to {
        color: transparent;
    }
    50% {
        color: azure;
    }
}
@-moz-keyframes blink_d {
    from,
    to {
        color: transparent;
    }
    50% {
        color: azure;
    }
}
@-webkit-keyframes blink_d {
    from,
    to {
        color: transparent;
    }
    50% {
        color: azure;
    }
}
@-ms-keyframes blink_d {
    from,
    to {
        color: transparent;
    }
    50% {
        color: azure;
    }
}
@-o-keyframes blink_d {
    from,
    to {
        color: transparent;
    }
    50% {
        color: azure;
    }
}
</style>
